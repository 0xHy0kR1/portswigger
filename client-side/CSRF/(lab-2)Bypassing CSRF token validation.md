## What is a CSRF token?
   - A CSRF token is a unique, secret, and unpredictable value that is generated by the server-side application and shared with the client.
   - When issuing a request to perform a sensitive action, such as submitting a form, the client must include the correct CSRF token. Otherwise, the server will refuse to perform the requested action.

>**A common way to share CSRF tokens with the client is to include them as a hidden parameter in an HTML form, for example:**
```js
<form name="change-email-form" action="/my-account/change-email" method="POST"> <label>Email</label> <input required type="email" name="email" value="example@normal-website.com"> <input required type="hidden" name="csrf" value="50FaWgdOhi9M9wyna8taR1k3ODOR8d6u"> <button class='button' type='submit'> Update email </button> </form>
```

>**Submitting this form results in the following request:**
```js
POST /my-account/change-email HTTP/1.1 
Host: normal-website.com 
Content-Length: 70 
Content-Type: application/x-www-form-urlencoded

csrf=50FaWgdOhi9M9wyna8taR1k3ODOR8d6u&email=example@normal-website.com
```

   - When implemented correctly, CSRF tokens help protect against CSRF attacks by making it difficult for an attacker to construct a valid request on behalf of the victim.
   - As the attacker has no way of predicting the correct value for the CSRF token, they won't be able to include it in the malicious request.

#### Note
   - CSRF tokens don't have to be sent as hidden parameters in a `POST` request.
   - Some applications place CSRF tokens in HTTP headers, for example. The way in which tokens are transmitted has a significant impact on the security of a mechanism as a whole.

## Common flaws in CSRF token validation
   CSRF vulnerabilities typically arise due to flawed validation of CSRF tokens. 

### Validation of CSRF token depends on request method
   - Some applications correctly validate the token when the request uses the POST method but skip the validation when the GET method is used.

>In this situation, the attacker can switch to the GET method to bypass the validation and deliver a CSRF attack:
```js
GET /email/change?email=pwned@evil-user.net HTTP/1.1 
Host: vulnerable-website.com 
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
```

## Steps to solve lab
### Title - CSRF where token validation depends on request method

**Desc** - This lab's email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests. To solve the lab, use your exploit server to host an HTML page that uses a [CSRF attack](https://portswigger.net/web-security/csrf) to change the viewer's email address.

**Credentials to login** - You can log in to your own account using the following credentials: `wiener:peter`

**Our end goal** - To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

1. Analyse the website and check that three key conditions must be in place for a CSRF attack to be possible:
After analysing the site, we come across a endpoint where it is possible to change the email of a user. So, change your email and at the same time intercept it with burpsuite.
![[csrf9.png]]
  - A relevant action - email change functionality.
   - Cookie based session handling.
   - No unpredictable request parameters - Satisfied(As you can see, there is CSRF token that we can't predict it). We can bypass CSRF token protection by changing the request method.

2. Now, we are going to create "CSRF POC" script with the help of burpsuite pro and for that right click on the request that we captured earlier with the help of burpsuite pro do the below steps:
"Engagement tools" > "Generate CSRF PoC"
![[csrf3.png]]

After doing the above steps, there is a new window pop up. 
Change the request method from "POST" to "GET" to solve the lab.
![[csrf10.png]]
In this window, click on "Options" and make sure to select first and last options and click "Regenerate" and copy the script.

3. Paste the payload that copied in the step 2.
![[csrf11.png]]
