- As mentioned earlier, if a website doesn't include a `SameSite` attribute when setting a cookie, Chrome automatically applies `Lax` restrictions by default.
- However, to avoid breaking single sign-on (SSO) mechanisms, it doesn't actually enforce these restrictions for the first 120 seconds on top-level `POST` requests. As a result, there is a two-minute window in which users may be susceptible to cross-site attacks.

#### Note - 
This two-minute window does not apply to cookies that were explicitly set with the `SameSite=Lax` attribute.

- The attack to happen within a short time window is not very practical. Instead, If you can find a tool or something on the target website that lets you make the victim get a new session cookie, you can do that first. Then, you can follow up with your main attack.
- For example, completing an OAuth-based login flow may result in a new session each time as the OAuth service doesn't necessarily know whether the user is still logged in to the target site.
- To refresh the cookie without the victim's help, you must use a special kind of webpage change (top-level navigation) that includes their security cookies. But this creates an extra challenge because you need to send the user back to your site in order to carry out a CSRF attack.


- **alternative approach:** You can make the security cookie refresh happen in a new browser tab so that the victim's current page isn't disturbed before launching the final attack. But there's a small problem with this method: Browsers typically block popup tabs unless the user manually opens them.
**For example, the following popup will be blocked by the browser by default:**
```js
window.open('https://vulnerable-website.com/login/sso');
```

**To get around this, you can wrap the statement in an `onclick` event handler as follows:**
```js
window.onclick = () => { 
	window.open('https://vulnerable-website.com/login/sso'); 
}
```

This way, the `window.open()` method is only invoked when the user clicks somewhere on the page.


## Steps to solve lab
### Title - SameSite Lax bypass via cookie refresh

**Desc** - This lab's change email function is vulnerable to CSRF. To solve the lab, perform a [CSRF attack](https://portswigger.net/web-security/csrf) that changes the victim's email address. You should use the provided exploit server to host your attack. The lab supports OAuth-based login. You can log in via your social media account with the following credentials: `wiener:peter`

**Creds** - wiener:peter

#### Note

The default [SameSite](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions) restrictions differ between browsers. As the victim uses Chrome, we recommend also using Chrome (or Burp's built-in Chromium browser) to test your exploit.


1. Analyse the website and check that three key conditions must be in place for a CSRF attack to be possible:
After analysing the site, we come across a endpoint where it is possible to change the email of a user. So, change your email and at the same time intercept it with burpsuite and sent it to Repeater.
![[csrf71.png]]
   - A relevant action - email change functionality.
   - Cookie based session handling.
   - No unpredictable request parameters - Satisfied(As you can see, there is no CSRF token that we can't predict it).

2. Now, we are going to create "CSRF POC" script with the help of burpsuite pro and for that right click on the request that we captured earlier with the help of burpsuite pro do the below steps:
"Engagement tools" > "Generate CSRF PoC"
![[csrf53.png]]

**After doing the above steps, there is a new window pop up.**
![[csrf54.png]]
In this window, click on "Options" and make sure to select first and last options and click "Regenerate" and copy the script.

3. As you know that, there is a "Samesite=Lax" restriction applied by default by the chrome. Google chrome doesn't apply any "Lax" restriction for almost 2 minutes and it means we've 2 minutes to deliver another link to victim and the first one helps to refresh the Session cookie and second one helps to change the email of victim.

**Payload**
```js
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
	<script>
	window.onclick = () => { 
	// The below "window.open" code helps to refresh the cookie of victim
		window.open('https://0abc007f04faf2a6803e77a500580044.web-security-academy.net/my-account/change-email'); 
    }
	</script>
    <form action="https://0abc007f04faf2a6803e77a500580044.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="sukuna&#64;protonmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

4. Copy the above payload and paste it on exploit-server and deliver the victim in two times in the limit of 2 minutes.
![[csrf72.png]]
