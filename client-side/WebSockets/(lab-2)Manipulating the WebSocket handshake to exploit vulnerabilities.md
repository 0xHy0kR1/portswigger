Some WebSockets vulnerabilities can only be found and exploited by manipulating the WebSocket handshake(look [[(lab-1)WebSockets overview]] of "You can manipulate the WebSocket handshake using Burp Repeater" section for reading). These vulnerabilities tend to involve design flaws, Design flaws in the context of WebSocket vulnerabilities refer to problems or mistakes in how the WebSocket communication is set up and managed. These issues can make the WebSocket system vulnerable to attacks. Here are some common design flaws explained simply:

1. **Misplaced Trust in HTTP Headers**: 
	- This means that sometimes WebSocket systems trust certain information in the HTTP headers too much. 
	- For example, they might rely on a header called "X-Forwarded-For" to make important security decisions. But if this header can be manipulated or faked by an attacker, it can lead to security problems.

2. **Flaws in Session Handling:**
	- WebSocket messages are often handled within a session, which is like a user's interaction with a web application. If there are problems with how these sessions are managed, it can create vulnerabilities.
	- Imagine if someone could mess with the session context during the WebSocket handshake; they might gain unauthorized access or control.

3. **Attack Surface with Custom HTTP Headers:**
	- Some applications use their own custom HTTP headers (additional information sent with requests). If these custom headers aren't properly secured or validated, they can open up opportunities for attackers to exploit weaknesses in the WebSocket system.


## Steps to solve lab
### Title - Manipulating the WebSocket handshake to exploit vulnerabilities

**Desc** - This online shop has a live chat feature implemented using WebSockets. It has an aggressive but flawed XSS filter. To solve the lab, use a WebSocket message to trigger an `alert()` popup in the support agent's browser.

1. Browse to the application function that uses WebSockets and also look for entries appearing in the WebSockets history tab within Burp Proxy.
![[WebSockets2.png]]

2. In the Intercept tab of Burp Proxy, ensure that interception is turned on. 
![[WebSockets3.png]]

3. When a WebSocket message is sent from the browser or server, it will be displayed in the Intercept tab for you to view or modify.
![[WebSockets5.png]]

![[WebSockets4.png]]

4. Send the WebSocket message to burp Repeater and paste the below payload instead of "hello" and observe that your ip is blacklisted.
**Payload** - 
```js
<img src=1 onerror='alert(1)'>
```

![[WebSockets8.png]]

5. Click "Reconnect", and observe that the connection attempt fails because your IP address has been banned.
![[WebSockets9.png]]

6. Add the following header to the handshake request to spoof your IP address:
**Header** - 
```js
X-Forwarded-For: 1.1.1.1
```

![[WebSockets11.png]]

![[WebSockets12.png]]

**Note** - You can add any IP address not just "1.1.1.1" for spoofing your ip.

7. Now, copy and paste the below payload to bypass the XSS filter.
**Payload** - 
```jsx
<img sRc=1 oNErRoR=alert`1`>
```

![[WebSockets13.png]]
